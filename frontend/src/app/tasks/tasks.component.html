<div class="tasks-container">
  <header class="tasks-header">
    <div class="header-left">
      <a href="https://www.veri-global.com/" target="_blank" rel="noopener noreferrer">
        <img src="../../../assets/icons/logo.png" alt="Logo" class="logo">
      </a>
    </div>
    <div class="header-center">
      <h1>My Tasks</h1>
    </div>
    <div class="header-right">
      <button class="btn btn-danger" (click)="logout()">Logout</button>
    </div>
  </header>

  <main class="tasks-main">
    <!-- Add/Edit Task Modal -->
    <div class="modal" [class.show]="showAddForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ editingTask ? 'Edit Task' : 'Add New Task' }}</h5>
            <button type="button" class="btn-close" (click)="toggleAddForm()" [disabled]="loading"></button>
          </div>
          <div class="modal-body">
            <div *ngIf="errorMessage" class="alert alert-danger mb-3">
              {{ errorMessage }}
            </div>
            <form (ngSubmit)="createTask()" #taskForm="ngForm">
              <div class="form-group">
                <label for="title" class="form-label">
                  Title * (must be unique)
                  <span class="char-count" [class.text-danger]="(newTask.title.length || 0) > 200">
                    {{ newTask.title.length || 0 }}/200
                  </span>
                </label>
                <input 
                  type="text" 
                  id="title" 
                  class="form-control" 
                  [(ngModel)]="newTask.title" 
                  name="title" 
                  required
                  maxlength="200"
                  #title="ngModel"
                  (paste)="handlePaste($event, 'title', 150)">
                <div class="invalid-feedback" *ngIf="title.invalid && (title.dirty || title.touched)">
                  <span *ngIf="title.errors?.['required']">Title is required</span>
                </div>
              </div>

              <div class="form-group">
                <label for="description" class="form-label">
                  Description
                </label>
                <textarea 
                  id="description" 
                  class="form-control" 
                  [(ngModel)]="newTask.description" 
                  name="description" 
                  rows="5"></textarea>
              </div>

              <div class="form-group">
                <label for="status" class="form-label">Status</label>
                <select 
                  id="status" 
                  class="form-control" 
                  [(ngModel)]="newTask.status" 
                  name="status">
                  <option value="PENDING">Pending</option>
                  <option value="COMPLETED">Completed</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="toggleAddForm()" [disabled]="loading">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" (click)="createTask()" [disabled]="loading || taskForm.invalid">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              {{ loading ? 'Saving...' : (editingTask ? 'Update Task' : 'Add Task') }}
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" [class.show]="showDeleteModal" *ngIf="taskToDelete">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" (click)="cancelDelete()" [disabled]="loading"></button>
          </div>
          <div class="modal-body text-center">
            <p>Are you sure you want to delete this task?</p>
            <div class="task-to-delete">
              <p class="mb-2"><strong>Title:</strong> {{ taskToDelete.title }}</p>
              <p class="mb-0">
                <span class="badge" 
                      [class.bg-warning]="taskToDelete.status === 'PENDING'"
                      [class.bg-success]="taskToDelete.status === 'COMPLETED'">
                  {{ taskToDelete.status === 'PENDING' ? 'Pending' : 'Completed' }}
                </span>
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cancelDelete()" [disabled]="loading">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              {{ loading ? 'Deleting...' : 'Delete' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Backdrop -->
    <div class="modal-backdrop fade show" *ngIf="showAddForm || showDeleteModal"></div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="loading && !showAddForm" class="loading-container">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Loading tasks...</p>
    </div>

    <!-- Tasks List -->
    <div *ngIf="!loading" class="tasks-list">
      <div class="tasks-actions">
        <button class="btn btn-success" (click)="toggleAddForm()">
          <i class="bi bi-plus"></i> Add Task
        </button>
      </div>

      <div *ngIf="tasks.length === 0" class="no-tasks">
        <p>You don't have any tasks yet. Click "Add Task" to create one!</p>
      </div>

      <div class="task-card" *ngFor="let task of tasks">
        <div class="task-header">
          <h3 class="task-title" [class.completed]="task.status === 'COMPLETED'">
            {{ task.title }}
          </h3>
          <div class="task-status">
            <span 
              class="badge" 
              [class.bg-warning]="task.status === 'PENDING'" 
              [class.bg-success]="task.status === 'COMPLETED'">
              {{ task.status === 'PENDING' ? 'Pending' : 'Completed' }}
            </span>
          </div>
        </div>

        <div class="task-body" *ngIf="task.description">
          <p>{{ task.description }}</p>
        </div>

        <div class="task-footer">
          <button 
            class="btn btn-sm" 
            [class.btn-outline-success]="task.status === 'PENDING'" 
            [class.btn-outline-warning]="task.status === 'COMPLETED'" 
            (click)="toggleTaskStatus(task)">
            {{ task.status === 'PENDING' ? 'Mark Complete' : 'Mark Pending' }}
          </button>
          <button class="btn btn-sm btn-outline-primary" (click)="startEditing(task)">
            Edit
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(task)">
            Delete
          </button>
        </div>
      </div>
    </div>
  </main>
</div>